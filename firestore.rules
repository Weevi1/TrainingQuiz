rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for multi-tenant access control
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserId() {
      return request.auth.uid;
    }

    // Check if user is Platform Admin (stored in global users collection)
    function isPlatformAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(getUserId())) &&
        get(/databases/$(database)/documents/users/$(getUserId())).data.platformRole == 'PLATFORM_ADMIN';
    }

    // Check if user is member of specific organization
    // Check both org-scoped users collection AND global users collection (for Platform Admins)
    function isOrgMember(orgId) {
      return isAuthenticated() && (
        exists(/databases/$(database)/documents/dev-organizations/$(orgId)/users/$(getUserId())) ||
        (exists(/databases/$(database)/documents/users/$(getUserId())) &&
         get(/databases/$(database)/documents/users/$(getUserId())).data.organizations[orgId] != null)
      );
    }

    // Get user role in specific organization
    function getUserRole(orgId) {
      // Try org-scoped collection first
      let orgUserPath = /databases/$(database)/documents/dev-organizations/$(orgId)/users/$(getUserId());
      let globalUserPath = /databases/$(database)/documents/users/$(getUserId());

      return exists(orgUserPath)
        ? get(orgUserPath).data.organizations[orgId].role
        : get(globalUserPath).data.organizations[orgId].role;
    }

    function hasRole(orgId, role) {
      return isOrgMember(orgId) && getUserRole(orgId) == role;
    }

    // Check if user has minimum role level (no indexOf in Firestore rules)
    function hasMinRole(orgId, minRole) {
      let userRole = getUserRole(orgId);
      // ORG_OWNER can do everything
      // ORG_ADMIN can do ORG_ADMIN, TRAINER, PARTICIPANT tasks
      // TRAINER can do TRAINER, PARTICIPANT tasks
      // PARTICIPANT can only do PARTICIPANT tasks
      return minRole == 'PARTICIPANT' ? true :
             minRole == 'TRAINER' ? (userRole == 'TRAINER' || userRole == 'ORG_ADMIN' || userRole == 'ORG_OWNER') :
             minRole == 'ORG_ADMIN' ? (userRole == 'ORG_ADMIN' || userRole == 'ORG_OWNER') :
             minRole == 'ORG_OWNER' ? (userRole == 'ORG_OWNER') :
             false;
    }

    // Global user profiles (ONLY for Platform Admins)
    match /users/{userId} {
      allow read, write: if isAuthenticated() && getUserId() == userId;
      allow read: if isPlatformAdmin();
    }

    // Development environment organizations
    match /dev-organizations/{orgId} {
      // Platform admins can read/write all organizations
      // Organization owners can read/write their organization
      allow read, write: if isPlatformAdmin() || isOrgMember(orgId);

      // Organization-scoped users collection
      match /users/{userId} {
        // Users can read/write their own profile
        allow read, write: if isAuthenticated() && getUserId() == userId;
        // Organization admins can read user profiles in their org
        allow read: if isOrgMember(orgId) && hasMinRole(orgId, 'ORG_ADMIN');
        // Platform admins can read/write all user profiles
        allow read, write: if isPlatformAdmin();
      }

      // Quizzes subcollection
      match /quizzes/{quizId} {
        allow read: if isOrgMember(orgId);
        allow write: if isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER');
      }

      // Sessions subcollection
      match /sessions/{sessionId} {
        allow read: if true; // Public read for QR code joining
        allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));

        // Participants subcollection
        match /participants/{participantId} {
          allow read, create, update: if true; // Anyone can join and participate
          allow delete: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));
        }

        // Game state and results
        match /{document=**} {
          allow read: if true;
          allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));
        }
      }

      // Analytics subcollection
      match /analytics/{document=**} {
        allow read: if isOrgMember(orgId);
        allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));
      }

      // Billing and subscription data
      match /billing/{document=**} {
        allow read, write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'ORG_OWNER'));
      }

      // Settings and branding
      match /settings/{document=**} {
        allow read: if isOrgMember(orgId);
        allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'ORG_ADMIN'));
      }
    }

    // Production environment organizations (same structure but no dev- prefix)
    match /organizations/{orgId} {
      allow read, write: if isPlatformAdmin() || isOrgMember(orgId);

      // Organization-scoped users collection
      match /users/{userId} {
        allow read, write: if isAuthenticated() && getUserId() == userId;
        allow read: if isOrgMember(orgId) && hasMinRole(orgId, 'ORG_ADMIN');
        allow read, write: if isPlatformAdmin();
      }

      // Quizzes subcollection
      match /quizzes/{quizId} {
        allow read: if isOrgMember(orgId);
        allow write: if isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER');
      }

      // Sessions subcollection
      match /sessions/{sessionId} {
        allow read: if true; // Public read for QR code joining
        allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));

        // Participants subcollection
        match /participants/{participantId} {
          allow read, create, update: if true; // Anyone can join and participate
          allow delete: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));
        }

        // Game state and results
        match /{document=**} {
          allow read: if true;
          allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));
        }
      }

      // Analytics subcollection
      match /analytics/{document=**} {
        allow read: if isOrgMember(orgId);
        allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));
      }

      // Billing and subscription data
      match /billing/{document=**} {
        allow read, write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'ORG_OWNER'));
      }

      // Settings and branding
      match /settings/{document=**} {
        allow read: if isOrgMember(orgId);
        allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'ORG_ADMIN'));
      }
    }

    // Legacy sessions (for backward compatibility during transition)
    match /dev-sessions/{sessionId} {
      allow read: if true; // Public read for QR code joining
      allow write: if isAuthenticated(); // Authenticated users can create/manage sessions

      match /{document=**} {
        allow read, write: if true; // Allow participant interactions
      }
    }

    // Fallback for Platform Admins during development
    match /{document=**} {
      allow read, write: if isPlatformAdmin();
    }
  }
}