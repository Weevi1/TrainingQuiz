rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for multi-tenant access control
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserId() {
      return request.auth.uid;
    }

    // Check if user is Platform Admin (stored in global users collection)
    function isPlatformAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(getUserId())) &&
        get(/databases/$(database)/documents/users/$(getUserId())).data.platformRole == 'PLATFORM_ADMIN';
    }

    // Check if user is member of specific organization (stored in org-scoped users collection)
    function isOrgMember(orgId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/dev-organizations/$(orgId)/users/$(getUserId()));
    }

    // Get user role in specific organization
    function getUserRole(orgId) {
      return get(/databases/$(database)/documents/dev-organizations/$(orgId)/users/$(getUserId())).data.organizations[orgId].role;
    }

    function hasRole(orgId, role) {
      return isOrgMember(orgId) && getUserRole(orgId) == role;
    }

    function hasMinRole(orgId, minRole) {
      let userRole = getUserRole(orgId);
      let roleHierarchy = ['PARTICIPANT', 'TRAINER', 'ORG_ADMIN', 'ORG_OWNER'];
      let userRoleIndex = roleHierarchy.indexOf(userRole);
      let minRoleIndex = roleHierarchy.indexOf(minRole);
      return userRoleIndex >= minRoleIndex;
    }

    // Global user profiles (ONLY for Platform Admins)
    match /users/{userId} {
      allow read, write: if isAuthenticated() && getUserId() == userId;
      allow read: if isPlatformAdmin();
    }

    // Development environment organizations
    match /dev-organizations/{orgId} {
      // Platform admins can read/write all organizations
      // Organization owners can read/write their organization
      allow read, write: if isPlatformAdmin() || isOrgMember(orgId);

      // Organization-scoped users collection
      match /users/{userId} {
        // Users can read/write their own profile
        allow read, write: if isAuthenticated() && getUserId() == userId;
        // Organization admins can read user profiles in their org
        allow read: if isOrgMember(orgId) && hasMinRole(orgId, 'ORG_ADMIN');
        // Platform admins can read/write all user profiles
        allow read, write: if isPlatformAdmin();
      }

      // Quizzes subcollection
      match /quizzes/{quizId} {
        allow read: if isOrgMember(orgId);
        allow write: if isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER');
      }

      // Sessions subcollection
      match /sessions/{sessionId} {
        allow read: if true; // Public read for QR code joining
        allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));

        // Participants subcollection
        match /participants/{participantId} {
          allow read, create, update: if true; // Anyone can join and participate
          allow delete: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));
        }

        // Game state and results
        match /{document=**} {
          allow read: if true;
          allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));
        }
      }

      // Analytics subcollection
      match /analytics/{document=**} {
        allow read: if isOrgMember(orgId);
        allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));
      }

      // Billing and subscription data
      match /billing/{document=**} {
        allow read, write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'ORG_OWNER'));
      }

      // Settings and branding
      match /settings/{document=**} {
        allow read: if isOrgMember(orgId);
        allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'ORG_ADMIN'));
      }
    }

    // Production environment organizations (same structure but no dev- prefix)
    match /organizations/{orgId} {
      allow read, write: if isPlatformAdmin() || isOrgMember(orgId);

      // Organization-scoped users collection
      match /users/{userId} {
        allow read, write: if isAuthenticated() && getUserId() == userId;
        allow read: if isOrgMember(orgId) && hasMinRole(orgId, 'ORG_ADMIN');
        allow read, write: if isPlatformAdmin();
      }

      // Quizzes subcollection
      match /quizzes/{quizId} {
        allow read: if isOrgMember(orgId);
        allow write: if isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER');
      }

      // Sessions subcollection
      match /sessions/{sessionId} {
        allow read: if true; // Public read for QR code joining
        allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));

        // Participants subcollection
        match /participants/{participantId} {
          allow read, create, update: if true; // Anyone can join and participate
          allow delete: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));
        }

        // Game state and results
        match /{document=**} {
          allow read: if true;
          allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));
        }
      }

      // Analytics subcollection
      match /analytics/{document=**} {
        allow read: if isOrgMember(orgId);
        allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'TRAINER'));
      }

      // Billing and subscription data
      match /billing/{document=**} {
        allow read, write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'ORG_OWNER'));
      }

      // Settings and branding
      match /settings/{document=**} {
        allow read: if isOrgMember(orgId);
        allow write: if isPlatformAdmin() || (isOrgMember(orgId) && hasMinRole(orgId, 'ORG_ADMIN'));
      }
    }

    // Legacy sessions (for backward compatibility during transition)
    match /dev-sessions/{sessionId} {
      allow read: if true; // Public read for QR code joining
      allow write: if isAuthenticated(); // Authenticated users can create/manage sessions

      match /{document=**} {
        allow read, write: if true; // Allow participant interactions
      }
    }

    // Fallback for Platform Admins during development
    match /{document=**} {
      allow read, write: if isPlatformAdmin();
    }
  }
}